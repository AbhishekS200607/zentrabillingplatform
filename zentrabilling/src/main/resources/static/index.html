<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zentra - Inventory Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
</head>
<body class="bg-gray-900 text-white">
    <!-- Sidebar -->
    <div class="flex">
        <div id="sidebar" class="w-64 bg-gray-800 min-h-screen p-4">
            <div class="mb-8">
                <h1 class="text-2xl font-bold text-blue-400">Zentra</h1>
                <p class="text-gray-400 text-sm">Inventory Management</p>
            </div>
            
            <nav class="space-y-2">
                <a href="#" onclick="showSection('overview')" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition-colors">
                    <ion-icon name="analytics-outline"></ion-icon>
                    <span>Overview</span>
                </a>
                <a href="#" onclick="showSection('billing')" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition-colors">
                    <ion-icon name="receipt-outline"></ion-icon>
                    <span>Billing</span>
                </a>
                <a href="#" onclick="showSection('customers')" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition-colors">
                    <ion-icon name="people-outline"></ion-icon>
                    <span>Customers</span>
                </a>
                <a href="#" onclick="showSection('inventory')" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition-colors">
                    <ion-icon name="cube-outline"></ion-icon>
                    <span>Inventory</span>
                </a>
                <a href="#" onclick="showSection('suppliers')" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition-colors">
                    <ion-icon name="business-outline"></ion-icon>
                    <span>Suppliers</span>
                </a>
                <a href="#" onclick="showSection('expenses')" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition-colors">
                    <ion-icon name="card-outline"></ion-icon>
                    <span>Expenses</span>
                </a>
                <a href="#" onclick="showSection('settings')" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition-colors">
                    <ion-icon name="settings-outline"></ion-icon>
                    <span>Settings</span>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-6">
            <!-- Overview Section -->
            <div id="overview" class="section">
                <h2 class="text-3xl font-bold mb-6">Dashboard Overview</h2>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400 text-sm">Today's Revenue</p>
                                <p id="todayRevenue" class="text-2xl font-bold text-green-400">â‚¹0</p>
                            </div>
                            <ion-icon name="trending-up-outline" class="text-green-400 text-2xl"></ion-icon>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400 text-sm">Monthly Revenue</p>
                                <p id="monthlyRevenue" class="text-2xl font-bold text-blue-400">â‚¹0</p>
                            </div>
                            <ion-icon name="calendar-outline" class="text-blue-400 text-2xl"></ion-icon>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400 text-sm">Today's Profit</p>
                                <p id="todayProfit" class="text-2xl font-bold text-purple-400">â‚¹0</p>
                            </div>
                            <ion-icon name="cash-outline" class="text-purple-400 text-2xl"></ion-icon>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800 p-6 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400 text-sm">Low Stock Items</p>
                                <p id="lowStockCount" class="text-2xl font-bold text-red-400">0</p>
                            </div>
                            <ion-icon name="warning-outline" class="text-red-400 text-2xl"></ion-icon>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-xl font-semibold mb-4">Low Stock Alerts</h3>
                    <div id="lowStockTable" class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="pb-2">Product</th>
                                    <th class="pb-2">Current Stock</th>
                                    <th class="pb-2">Threshold</th>
                                    <th class="pb-2">Status</th>
                                </tr>
                            </thead>
                            <tbody id="lowStockTableBody">
                                <!-- Low stock items will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Billing Section -->
            <div id="billing" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Billing</h2>
                    <div class="space-x-2">
                        <button onclick="showCustomerModal()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg">+ Add Customer</button>
                        <button onclick="showProductModal()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg">+ Add Product</button>
                        <button onclick="showInvoiceModal()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">Create Invoice</button>
                    </div>
                </div>
                
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-xl font-semibold mb-4">Recent Invoices</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="pb-2">Invoice #</th>
                                    <th class="pb-2">Date</th>
                                    <th class="pb-2">Customer</th>
                                    <th class="pb-2">Total</th>
                                    <th class="pb-2">Status</th>
                                    <th class="pb-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTable">
                                <!-- Invoices will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Customers Section -->
            <div id="customers" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Customers</h2>
                    <button onclick="showCustomerModal()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">Add Customer</button>
                </div>
                
                <div class="bg-gray-800 p-6 rounded-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="pb-2">Name</th>
                                    <th class="pb-2">Phone</th>
                                    <th class="pb-2">Email</th>
                                    <th class="pb-2">Address</th>
                                    <th class="pb-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customersTable">
                                <!-- Customers will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Inventory Section -->
            <div id="inventory" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Inventory</h2>
                    <div class="flex space-x-2">
                        <button onclick="startBarcodeScanner('inventory')" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg">ðŸ“± Scan Barcode</button>
                        <button onclick="showProductModal()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">Add Product</button>
                    </div>
                </div>
                
                <div class="bg-gray-800 p-6 rounded-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="pb-2">Name</th>
                                    <th class="pb-2">Category</th>
                                    <th class="pb-2">Barcode</th>
                                    <th class="pb-2">Buying Price</th>
                                    <th class="pb-2">Selling Price</th>
                                    <th class="pb-2">Stock</th>
                                    <th class="pb-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTable">
                                <!-- Products will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Suppliers Section -->
            <div id="suppliers" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Suppliers</h2>
                    <button onclick="showSupplierModal()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">Add Supplier</button>
                </div>
                
                <div class="bg-gray-800 p-6 rounded-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="pb-2">Name</th>
                                    <th class="pb-2">Phone</th>
                                    <th class="pb-2">Email</th>
                                    <th class="pb-2">Total Products</th>
                                    <th class="pb-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="suppliersTable">
                                <!-- Suppliers will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Expenses Section -->
            <div id="expenses" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Expenses</h2>
                    <button onclick="showExpenseModal()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">Add Expense</button>
                </div>
                
                <div class="bg-gray-800 p-6 rounded-lg">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="pb-2">Description</th>
                                    <th class="pb-2">Category</th>
                                    <th class="pb-2">Amount</th>
                                    <th class="pb-2">Date</th>
                                    <th class="pb-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="expensesTable">
                                <!-- Expenses will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="section hidden">
                <h2 class="text-3xl font-bold mb-6">Settings</h2>
                
                <div class="bg-gray-800 p-6 rounded-lg">
                    <h3 class="text-xl font-semibold mb-4">Business Information</h3>
                    <form id="settingsForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Business Name</label>
                                <input type="text" id="businessName" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">GSTIN</label>
                                <input type="text" id="gstin" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Phone</label>
                                <input type="text" id="businessPhone" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Email</label>
                                <input type="email" id="businessEmail" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium mb-2">Address</label>
                                <textarea id="businessAddress" rows="3" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Default Tax Rate (%)</label>
                                <input type="number" id="defaultTaxRate" step="0.01" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                            </div>
                        </div>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg">Save Settings</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Product Modal -->
    <div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Add/Edit Product</h3>
            <form id="productForm" class="space-y-4">
                <input type="hidden" id="productId">
                <div>
                    <label class="block text-sm font-medium mb-2">Product Name</label>
                    <input type="text" id="productName" required class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Category</label>
                    <input type="text" id="productCategory" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Barcode</label>
                    <input type="text" id="productBarcode" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Buying Price</label>
                        <input type="number" id="productCostPrice" step="0.01" required class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Selling Price</label>
                        <input type="number" id="productSellingPrice" step="0.01" required class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Stock Quantity</label>
                    <input type="number" id="productStock" required class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">Save</button>
                    <button type="button" onclick="hideProductModal()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="customerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Add/Edit Customer</h3>
            <form id="customerForm" class="space-y-4">
                <input type="hidden" id="customerId">
                <div>
                    <label class="block text-sm font-medium mb-2">Customer Name</label>
                    <input type="text" id="customerName" required class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Phone</label>
                    <input type="text" id="customerPhone" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Email</label>
                    <input type="email" id="customerEmail" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Address</label>
                    <textarea id="customerAddress" rows="3" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500"></textarea>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">Save</button>
                    <button type="button" onclick="hideCustomerModal()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg w-full max-w-4xl max-h-screen overflow-y-auto">
            <h3 class="text-xl font-semibold mb-4">Create Invoice</h3>
            <form id="invoiceForm" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Customer</label>
                        <div class="flex space-x-2">
                            <select id="invoiceCustomer" class="flex-1 p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                                <option value="">Walk-in Customer</option>
                            </select>
                            <button type="button" onclick="quickAddCustomer()" class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg text-sm">+ Add</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Tax Rate (%)</label>
                        <input type="number" id="invoiceTaxRate" value="18" step="0.01" oninput="calculateTotals()" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                    </div>
                </div>

                <!-- Invoice Items -->
                <div>
                    <h4 class="text-lg font-semibold mb-2">Items</h4>
                    <div id="invoiceItems" class="space-y-2">
                        <!-- Initial item row -->
                    </div>
                    <div class="flex space-x-2 mt-2">
                        <button type="button" onclick="startBarcodeScanner('invoice')" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg">ðŸ“± Scan Product</button>
                        <button type="button" onclick="addInvoiceItem()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg">+ Add Item</button>
                    </div>
                </div>

                <!-- Totals -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Subtotal</label>
                            <input type="number" id="invoiceSubtotal" step="0.01" value="0.00" readonly class="w-full p-3 bg-gray-600 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Tax Amount</label>
                            <input type="number" id="invoiceTaxAmount" step="0.01" value="0.00" readonly class="w-full p-3 bg-gray-600 rounded-lg">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium mb-2">Grand Total</label>
                            <input type="number" id="invoiceGrandTotal" step="0.01" value="0.00" readonly class="w-full p-3 bg-gray-600 rounded-lg text-xl font-bold">
                        </div>
                    </div>
                </div>

                <div class="flex space-x-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg">Create Invoice</button>
                    <button type="button" onclick="hideInvoiceModal()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Supplier Modal -->
    <div id="supplierModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Add/Edit Supplier</h3>
            <form id="supplierForm" class="space-y-4">
                <input type="hidden" id="supplierId">
                <div>
                    <label class="block text-sm font-medium mb-2">Supplier Name</label>
                    <input type="text" id="supplierName" required class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Phone</label>
                    <input type="text" id="supplierPhone" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Email</label>
                    <input type="email" id="supplierEmail" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Address</label>
                    <textarea id="supplierAddress" rows="3" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500"></textarea>
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">Save</button>
                    <button type="button" onclick="hideSupplierModal()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Add/Edit Expense</h3>
            <form id="expenseForm" class="space-y-4">
                <input type="hidden" id="expenseId">
                <div>
                    <label class="block text-sm font-medium mb-2">Description</label>
                    <input type="text" id="expenseDescription" required class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Category</label>
                    <select id="expenseCategory" required class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                        <option value="">Select Category</option>
                        <option value="Office Supplies">Office Supplies</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Travel">Travel</option>
                        <option value="Equipment">Equipment</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Amount</label>
                    <input type="number" id="expenseAmount" step="0.01" required class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Date</label>
                    <input type="date" id="expenseDate" required class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500">
                </div>
                <div class="flex space-x-4">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">Save</button>
                    <button type="button" onclick="hideExpenseModal()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Invoice Modal -->
    <div id="viewInvoiceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg w-full max-w-2xl max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Invoice Details</h3>
                <button onclick="hideViewInvoiceModal()" class="text-gray-400 hover:text-white">
                    <ion-icon name="close-outline" class="text-2xl"></ion-icon>
                </button>
            </div>
            <div id="invoiceDetails">
                <!-- Invoice details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div id="barcodeModal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-white">Scan Barcode</h3>
                <button onclick="stopBarcodeScanner()" class="text-gray-400 hover:text-white">
                    <ion-icon name="close-outline" class="text-2xl"></ion-icon>
                </button>
            </div>
            <div class="relative">
                <video id="barcodeVideo" class="w-full h-64 bg-black rounded-lg" autoplay muted playsinline></video>
                <canvas id="barcodeCanvas" class="hidden" willReadFrequently="true"></canvas>
                <div class="absolute inset-0 border-2 border-red-500 rounded-lg pointer-events-none">
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-48 h-32 border-2 border-green-400 bg-transparent"></div>
                </div>
            </div>
            <div class="mt-4 text-center">
                <p class="text-gray-300 text-sm">Position barcode within the green frame</p>
                <div id="barcodeResult" class="mt-2 text-green-400 font-semibold"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let products = [];
        let customers = [];
        let suppliers = [];
        let currentEditId = null;

        // API Base URL
        const API_BASE = 'http://localhost:8080/api';

        // Utility function for API calls
        async function apiCall(endpoint, method = 'GET', data = null) {
            const config = {
                method,
                headers: { 'Content-Type': 'application/json' },
            };
            
            if (data) {
                config.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, config);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`HTTP error! status: ${response.status}`, errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                if (response.status === 204 || response.headers.get("content-length") === "0") {
                    return null;
                }
                return response.json();
            } catch (error) {
                console.error('API Call failed:', error);
                throw error;
            }
        }

        // Section navigation
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            const activeSection = document.getElementById(sectionName);
            if (activeSection) {
                 activeSection.classList.remove('hidden');
            }
           
            switch(sectionName) {
                case 'overview': loadDashboard(); break;
                case 'billing': loadInvoices(); break;
                case 'customers': loadCustomers(); break;
                case 'inventory': loadProducts(); break;
                case 'suppliers': loadSuppliers(); break;
                case 'expenses': loadExpenses(); break;
                case 'settings': loadSettings(); break;
            }
        }

        // Dashboard functions
        async function loadDashboard() {
            try {
                // Get real data from APIs
                const [invoices, products, expenses] = await Promise.all([
                    apiCall('/invoices'),
                    apiCall('/products'),
                    apiCall('/expenses')
                ]);
                
                // Calculate today's revenue (paid invoices)
                const today = new Date().toISOString().split('T')[0];
                const todayInvoices = invoices.filter(inv => 
                    inv.invoiceDate?.startsWith(today) && inv.paymentStatus === 'PAID'
                );
                const todayRevenue = todayInvoices.reduce((sum, inv) => sum + (inv.grandTotal || 0), 0);
                
                // Calculate monthly revenue
                const currentMonth = new Date().toISOString().substring(0, 7);
                const monthlyInvoices = invoices.filter(inv => 
                    inv.invoiceDate?.startsWith(currentMonth) && inv.paymentStatus === 'PAID'
                );
                const monthlyRevenue = monthlyInvoices.reduce((sum, inv) => sum + (inv.grandTotal || 0), 0);
                
                // Calculate today's expenses
                const todayExpenses = expenses.filter(exp => exp.date?.startsWith(today));
                const todayExpenseTotal = todayExpenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
                const todayProfit = todayRevenue - todayExpenseTotal;
                
                // Count low stock products
                const lowStockProducts = products.filter(p => p.stock <= p.threshold);
                
                // Update dashboard
                document.getElementById('todayRevenue').textContent = `Rs.${todayRevenue.toFixed(2)}`;
                document.getElementById('monthlyRevenue').textContent = `Rs.${monthlyRevenue.toFixed(2)}`;
                document.getElementById('todayProfit').textContent = `Rs.${todayProfit.toFixed(2)}`;
                document.getElementById('lowStockCount').textContent = lowStockProducts.length;
                
                loadLowStockTable(lowStockProducts);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                // Show default values on error
                document.getElementById('todayRevenue').textContent = 'Rs.0.00';
                document.getElementById('monthlyRevenue').textContent = 'Rs.0.00';
                document.getElementById('todayProfit').textContent = 'Rs.0.00';
                document.getElementById('lowStockCount').textContent = '0';
            }
        }

        function loadLowStockTable(products) {
            const tbody = document.getElementById('lowStockTableBody');
            tbody.innerHTML = '';
            if (!products || products.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No low stock items.</td></tr>';
                 return;
            }
            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2">${product.name}</td>
                    <td class="py-2">${product.stock}</td>
                    <td class="py-2">${product.lowStockThreshold}</td>
                    <td class="py-2"><span class="bg-red-600 px-2 py-1 rounded text-xs">Low Stock</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Product functions
        async function loadProducts() {
            try {
                products = await apiCall('/products');
                const tbody = document.getElementById('productsTable');
                tbody.innerHTML = '';
                 if (!products || products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No products found. Add one to get started.</td></tr>';
                    return;
                }
                products.forEach(product => {
                    const row = document.createElement('tr');
                    const stockClass = product.stock <= product.lowStockThreshold ? 'text-red-400' : 'text-green-400';
                    row.innerHTML = `
                        <td class="py-2">${product.name}</td>
                        <td class="py-2">${product.category || '-'}</td>
                        <td class="py-2">${product.barcode || '-'}</td>
                        <td class="py-2">â‚¹${(product.costPrice || 0).toFixed(2)}</td>
                        <td class="py-2">â‚¹${(product.sellingPrice || 0).toFixed(2)}</td>
                        <td class="py-2 ${stockClass}">${product.stock}</td>
                        <td class="py-2">
                            <button onclick="editProduct(${product.id})" class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs mr-1">Edit</button>
                            <button onclick="deleteProduct(${product.id})" class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        function showProductModal(productId = null) {
            currentEditId = productId;
            const modal = document.getElementById('productModal');
            const form = document.getElementById('productForm');
            form.reset();
            
            if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('productId').value = product.id;
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productCategory').value = product.category || '';
                    document.getElementById('productBarcode').value = product.barcode || '';
                    document.getElementById('productCostPrice').value = product.costPrice;
                    document.getElementById('productSellingPrice').value = product.sellingPrice;
                    document.getElementById('productStock').value = product.stock;
                }
            } else {
                 document.getElementById('productId').value = '';
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideProductModal() {
            document.getElementById('productModal').classList.add('hidden');
            document.getElementById('productModal').classList.remove('flex');
        }

        async function saveProduct(event) {
            event.preventDefault();
            
            const productData = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                barcode: document.getElementById('productBarcode').value,
                costPrice: parseFloat(document.getElementById('productCostPrice').value),
                sellingPrice: parseFloat(document.getElementById('productSellingPrice').value),
                stock: parseInt(document.getElementById('productStock').value)
            };
            
            try {
                const id = document.getElementById('productId').value;
                if (id) {
                    await apiCall(`/products/${id}`, 'PUT', productData);
                } else {
                    await apiCall('/products', 'POST', productData);
                }
                
                hideProductModal();
                loadProducts();
                if (!document.getElementById('overview').classList.contains('hidden')) {
                    loadDashboard();
                }
            } catch (error) {
                alert('Error saving product');
            }
        }

        function editProduct(id) {
            showProductModal(id);
        }

        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    await apiCall(`/products/${id}`, 'DELETE');
                    loadProducts();
                } catch (error) {
                    alert('Error deleting product');
                }
            }
        }

        // Customer functions
        async function loadCustomers() {
            try {
                customers = await apiCall('/customers');
                const tbody = document.getElementById('customersTable');
                tbody.innerHTML = '';
                 if (!customers || customers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No customers found.</td></tr>';
                    return;
                }
                customers.forEach(customer => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="py-2">${customer.name}</td>
                        <td class="py-2">${customer.phone || '-'}</td>
                        <td class="py-2">${customer.email || '-'}</td>
                        <td class="py-2">${customer.address || '-'}</td>
                        <td class="py-2">
                            <button onclick="editCustomer(${customer.id})" class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs mr-1">Edit</button>
                            <button onclick="deleteCustomer(${customer.id})" class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                updateCustomerDropdown();
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        function showCustomerModal(customerId = null) {
            const modal = document.getElementById('customerModal');
            const form = document.getElementById('customerForm');
            form.reset();
            
            if (customerId) {
                const customer = customers.find(c => c.id === customerId);
                if (customer) {
                    document.getElementById('customerId').value = customer.id;
                    document.getElementById('customerName').value = customer.name;
                    document.getElementById('customerPhone').value = customer.phone || '';
                    document.getElementById('customerEmail').value = customer.email || '';
                    document.getElementById('customerAddress').value = customer.address || '';
                }
            } else {
                document.getElementById('customerId').value = '';
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideCustomerModal() {
            document.getElementById('customerModal').classList.add('hidden');
            document.getElementById('customerModal').classList.remove('flex');
        }

        async function saveCustomer(event) {
            event.preventDefault();
            const customerData = {
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                email: document.getElementById('customerEmail').value,
                address: document.getElementById('customerAddress').value
            };
            
            try {
                const id = document.getElementById('customerId').value;
                if (id) {
                    await apiCall(`/customers/${id}`, 'PUT', customerData);
                } else {
                    await apiCall('/customers', 'POST', customerData);
                }
                hideCustomerModal();
                loadCustomers();
            } catch (error) {
                alert('Error saving customer');
            }
        }

        function editCustomer(id) {
            showCustomerModal(id);
        }

        async function deleteCustomer(id) {
            if (confirm('Are you sure you want to delete this customer?')) {
                try {
                    await apiCall(`/customers/${id}`, 'DELETE');
                    loadCustomers();
                } catch (error) {
                    alert('Error deleting customer');
                }
            }
        }

        function updateCustomerDropdown() {
            const select = document.getElementById('invoiceCustomer');
            select.innerHTML = '<option value="">Walk-in Customer</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} - ${customer.phone || 'No phone'}`;
                select.appendChild(option);
            });
        }

        // Invoice functions
        async function loadInvoices() {
             try {
                await loadCustomers(); // Ensure customers are loaded first
                const invoices = await apiCall('/invoices');
                const tbody = document.getElementById('invoicesTable');
                tbody.innerHTML = '';

                if (!invoices || invoices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="py-4 text-center">No invoices found.</td></tr>';
                    return;
                }
                invoices.forEach(invoice => {
                    const customer = customers.find(c => c.id === invoice.customerId);
                    const customerName = customer ? customer.name : 'Walk-in Customer';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="py-2">${invoice.invoiceNumber || 'N/A'}</td>
                        <td class="py-2">${invoice.invoiceDate || 'N/A'}</td>
                        <td class="py-2">${customerName}</td>
                        <td class="py-2">â‚¹${(invoice.grandTotal || 0).toFixed(2)}</td>
                        <td class="py-2">
                            <span class="${invoice.paymentStatus === 'PAID' ? 'bg-green-600' : 'bg-red-600'} px-2 py-1 rounded text-xs">
                                ${invoice.paymentStatus || 'UNPAID'}
                            </span>
                        </td>
                        <td class="py-2">
                            <button onclick="viewInvoice(${invoice.id})" class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs mr-1">View</button>
                            <button onclick="togglePaymentStatus(${invoice.id}, '${invoice.paymentStatus}')" class="${invoice.paymentStatus === 'PAID' ? 'bg-orange-600' : 'bg-green-600'} hover:bg-orange-700 px-2 py-1 rounded text-xs mr-1">
                                ${invoice.paymentStatus === 'PAID' ? 'Mark Unpaid' : 'Mark Paid'}
                            </button>
                            <button onclick="downloadInvoicePDF(${invoice.id})" class="bg-purple-600 hover:bg-purple-700 px-2 py-1 rounded text-xs mr-1">PDF</button>
                            <button onclick="deleteInvoice(${invoice.id})" class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading invoices:', error);
            }
        }

        function showInvoiceModal() {
            const modal = document.getElementById('invoiceModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('invoiceForm').reset();
            document.getElementById('invoiceItems').innerHTML = '';
            addInvoiceItem(); 
            calculateTotals();
            loadCustomers();
        }

        function hideInvoiceModal() {
            document.getElementById('invoiceModal').classList.add('hidden');
            document.getElementById('invoiceModal').classList.remove('flex');
        }

        async function searchProduct(input) {
            const query = input.value.trim();
            const resultsDiv = input.parentElement.querySelector('.search-results');
            
            if (query.length < 1) {
                resultsDiv.classList.add('hidden');
                return;
            }
            
            try {
                const searchResults = await apiCall(`/products/search?q=${encodeURIComponent(query)}`);
                resultsDiv.innerHTML = '';
                
                if (searchResults.length > 0) {
                    searchResults.slice(0, 5).forEach(product => {
                        const div = document.createElement('div');
                        div.className = 'p-2 hover:bg-gray-600 cursor-pointer border-b border-gray-600';
                        div.innerHTML = `${product.name} - â‚¹${(product.sellingPrice || 0).toFixed(2)} - Stock: ${product.stock}`;
                        div.onclick = () => selectProduct(input, product);
                        resultsDiv.appendChild(div);
                    });
                    resultsDiv.classList.remove('hidden');
                } else {
                    resultsDiv.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error searching products:', error);
            }
        }

        function selectProduct(input, product) {
            const item = input.closest('.invoice-item');
            input.value = product.name;
            item.querySelector('.product-id').value = product.id;
            item.querySelector('.item-price').value = (product.sellingPrice || 0).toFixed(2);
            input.parentElement.querySelector('.search-results').classList.add('hidden');
            calculateItemTotal(item.querySelector('.item-quantity'));
        }

        function calculateItemTotal(quantityInput) {
            const item = quantityInput.closest('.invoice-item');
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(item.querySelector('.item-price').value) || 0;
            item.querySelector('.item-total').value = (quantity * price).toFixed(2);
            calculateTotals();
        }

        function calculateTotals() {
            let subtotal = 0;
            document.querySelectorAll('.invoice-item').forEach(item => {
                subtotal += parseFloat(item.querySelector('.item-total').value) || 0;
            });
            
            const taxRate = parseFloat(document.getElementById('invoiceTaxRate').value) || 0;
            const taxAmount = (subtotal * taxRate) / 100;
            const grandTotal = subtotal + taxAmount;
            
            document.getElementById('invoiceSubtotal').value = subtotal.toFixed(2);
            document.getElementById('invoiceTaxAmount').value = taxAmount.toFixed(2);
            document.getElementById('invoiceGrandTotal').value = grandTotal.toFixed(2);
        }

        function addInvoiceItem() {
            const container = document.getElementById('invoiceItems');
            const newItem = document.createElement('div');
            newItem.className = 'invoice-item grid grid-cols-12 gap-2 items-end';
            newItem.innerHTML = `
                <div class="col-span-5 relative">
                    <label class="block text-sm font-medium mb-1">Product</label>
                    <input type="text" class="product-search w-full p-2 bg-gray-700 rounded border border-gray-600 focus:border-blue-500" placeholder="Search..." oninput="searchProduct(this)" autocomplete="off">
                    <div class="search-results absolute top-full left-0 right-0 bg-gray-700 border border-gray-600 rounded-b max-h-40 overflow-y-auto z-10 hidden"></div>
                    <input type="hidden" class="product-id">
                </div>
                <div class="col-span-2"><label class="block text-sm font-medium mb-1">Qty</label><input type="number" class="item-quantity w-full p-2 bg-gray-700 rounded" value="1" min="1" oninput="calculateItemTotal(this)"></div>
                <div class="col-span-2"><label class="block text-sm font-medium mb-1">Price</label><input type="number" class="item-price w-full p-2 bg-gray-700 rounded" readonly></div>
                <div class="col-span-2"><label class="block text-sm font-medium mb-1">Total</label><input type="number" class="item-total w-full p-2 bg-gray-700 rounded" readonly></div>
                <div class="col-span-1"><button type="button" onclick="removeInvoiceItem(this)" class="bg-red-600 hover:bg-red-700 p-2 rounded text-sm w-full">Ã—</button></div>
            `;
            container.appendChild(newItem);
        }

        function removeInvoiceItem(button) {
            const container = document.getElementById('invoiceItems');
            if (container.children.length > 1) {
                button.closest('.invoice-item').remove();
                calculateTotals();
            }
        }

        async function saveInvoice(event) {
            event.preventDefault();
            const grandTotal = parseFloat(document.getElementById('invoiceGrandTotal').value);
            if (grandTotal <= 0) {
                alert('Please add items to the invoice.');
                return;
            }

            const invoiceData = {
                customerId: document.getElementById('invoiceCustomer').value || null,
                subtotal: parseFloat(document.getElementById('invoiceSubtotal').value),
                taxRate: parseFloat(document.getElementById('invoiceTaxRate').value),
                taxAmount: parseFloat(document.getElementById('invoiceTaxAmount').value),
                total: grandTotal
            };

            try {
                const savedInvoice = await apiCall('/invoices', 'POST', invoiceData);
                const items = document.querySelectorAll('.invoice-item');
                for (const item of items) {
                    const productId = item.querySelector('.product-id').value;
                    if (productId) {
                        const itemData = {
                            invoiceId: savedInvoice.id,
                            productId: parseInt(productId),
                            quantity: parseInt(item.querySelector('.item-quantity').value),
                            unitPrice: parseFloat(item.querySelector('.item-price').value),
                            total: parseFloat(item.querySelector('.item-total').value),
                        };
                        await apiCall('/invoice-items', 'POST', itemData);
                    }
                }
                hideInvoiceModal();
                loadInvoices();
                alert('Invoice created successfully!');
            } catch (error) {
                alert('Error creating invoice');
            }
        }
        
        async function quickAddCustomer() {
            const name = prompt('Enter customer name:');
            if (!name) return;
            const phone = prompt('Enter customer phone:');
            
            try {
                const newCustomer = await apiCall('/customers', 'POST', { name, phone });
                await loadCustomers();
                document.getElementById('invoiceCustomer').value = newCustomer.id;
            } catch (error) {
                alert('Error adding customer');
            }
        }

        async function viewInvoice(id) {
            try {
                const invoice = await apiCall(`/invoices/${id}`);
                const items = await apiCall(`/invoice-items/invoice/${id}`);
                
                const customer = customers.find(c => c.id === invoice.customerId);
                const customerName = customer ? customer.name : 'Walk-in Customer';

                let itemsHtml = items.map(item => {
                     const product = products.find(p => p.id === item.productId);
                     return `
                        <div class="grid grid-cols-4 gap-2 py-1">
                           <span>${product ? product.name : 'Product not found'}</span>
                           <span class="text-right">${item.quantity}</span>
                           <span class="text-right">â‚¹${(item.unitPrice || 0).toFixed(2)}</span>
                           <span class="text-right">â‚¹${(item.total || 0).toFixed(2)}</span>
                        </div>`;
                }).join('');

                document.getElementById('invoiceDetails').innerHTML = `
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><h4 class="font-semibold">Invoice #</h4><p>${invoice.invoiceNumber}</p></div>
                            <div><h4 class="font-semibold">Date</h4><p>${invoice.invoiceDate}</p></div>
                            <div><h4 class="font-semibold">Customer</h4><p>${customerName}</p></div>
                            <div><h4 class="font-semibold">Payment</h4><p class="${invoice.paymentStatus === 'PAID' ? 'text-green-400' : 'text-red-400'}">${invoice.paymentStatus}</p></div>
                        </div>
                        <div class="bg-gray-700 p-4 rounded">
                            <h4 class="font-semibold mb-2">Items</h4>
                            <div class="grid grid-cols-4 gap-2 font-bold border-b border-gray-600 pb-2 mb-2">
                                <span>Product</span><span class="text-right">Qty</span><span class="text-right">Price</span><span class="text-right">Total</span>
                            </div>
                            ${itemsHtml}
                        </div>
                        <div class="bg-gray-700 p-4 rounded text-right">
                            <div>Subtotal: â‚¹${(invoice.subtotal || 0).toFixed(2)}</div>
                            <div>Tax: â‚¹${(invoice.taxAmount || 0).toFixed(2)}</div>
                            <div class="font-bold text-lg mt-2">Grand Total: â‚¹${(invoice.grandTotal || 0).toFixed(2)}</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('viewInvoiceModal').classList.remove('hidden');
                document.getElementById('viewInvoiceModal').classList.add('flex');
            } catch (error) {
                alert('Error loading invoice details');
            }
        }

        function hideViewInvoiceModal() {
            document.getElementById('viewInvoiceModal').classList.add('hidden');
            document.getElementById('viewInvoiceModal').classList.remove('flex');
        }
        
        async function togglePaymentStatus(id, currentStatus) {
            const newStatus = currentStatus === 'PAID' ? 'UNPAID' : 'PAID';
            try {
                const invoice = await apiCall(`/invoices/${id}`);
                invoice.paymentStatus = newStatus;
                await apiCall(`/invoices/${id}`, 'PUT', invoice);
                loadInvoices();
                hideViewInvoiceModal();
            } catch (error) {
                alert('Failed to update payment status.');
            }
        }


        async function downloadInvoicePDF(id) {
            try {
                const [invoice, items, settings, allProducts] = await Promise.all([
                    apiCall(`/invoices/${id}`),
                    apiCall(`/invoice-items/invoice/${id}`),
                    apiCall('/settings'),
                    apiCall('/products')
                ]);
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const setting = settings[0] || {};
                const customer = customers.find(c => c.id === invoice.customerId);
                
                // Professional Header with Gradient Effect
                doc.setFillColor(41, 128, 185); // Professional Blue
                doc.rect(0, 0, 210, 50, 'F');
                doc.setFillColor(52, 152, 219); // Lighter Blue
                doc.rect(0, 40, 210, 10, 'F');
                
                // Company Info (White text on blue)
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.text(setting.businessName || 'ZENTRA BUSINESS', 20, 25);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text(setting.address || 'Your Business Address Here', 20, 33);
                doc.text(`GST: ${setting.gstin || 'XXXXXXXXXXXXXXXXX'}`, 20, 40);
                
                // Contact Info (Right side)
                doc.setFontSize(10);
                doc.text(`Phone: ${setting.phone || '+91 XXXXX XXXXX'}`, 120, 25);
                doc.text(`Email: ${setting.email || 'info@business.com'}`, 120, 33);
                doc.text(`Website: www.yourbusiness.com`, 120, 40);
                
                // Invoice Title Section
                doc.setTextColor(0, 0, 0);
                doc.setFillColor(241, 196, 15); // Golden Yellow
                doc.rect(130, 60, 65, 20, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.text('INVOICE', 145, 73);
                
                // Invoice Details Box
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text(`Invoice No: ${invoice.invoiceNumber || 'INV-XXXX'}`, 130, 90);
                doc.text(`Date: ${invoice.invoiceDate || new Date().toLocaleDateString()}`, 130, 98);
                doc.text(`Status: ${invoice.paymentStatus || 'UNPAID'}`, 130, 106);
                
                // Customer Section with Border
                doc.setDrawColor(41, 128, 185);
                doc.setLineWidth(0.5);
                doc.rect(20, 60, 100, 50);
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.text('BILL TO:', 25, 75);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                const customerName = customer ? customer.name : 'Walk-in Customer';
                doc.text(customerName, 25, 85);
                if (customer?.phone) doc.text(`Phone: ${customer.phone}`, 25, 93);
                if (customer?.email) doc.text(`Email: ${customer.email}`, 25, 101);
                if (customer?.address) {
                    const addressLines = doc.splitTextToSize(customer.address, 90);
                    doc.text(addressLines, 25, 109);
                }
                
                // Items Table with Enhanced Styling
                const tableData = items.map((item, index) => {
                    const product = allProducts.find(p => p.id === item.productId);
                    return [
                        (index + 1).toString(),
                        product ? product.name : 'Unknown Product',
                        item.quantity.toString(),
                        `Rs.${(item.unitPrice || 0).toFixed(2)}`,
                        `Rs.${(item.total || 0).toFixed(2)}`
                    ];
                });
                
                doc.autoTable({
                    startY: 125,
                    head: [['S.No', 'Item Description', 'Qty', 'Unit Price', 'Amount']],
                    body: tableData,
                    theme: 'striped',
                    headStyles: { 
                        fillColor: [41, 128, 185],
                        textColor: [255, 255, 255],
                        fontSize: 11,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    bodyStyles: {
                        fontSize: 10,
                        cellPadding: 4
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    },
                    columnStyles: {
                        0: { cellWidth: 15, halign: 'center' },
                        1: { cellWidth: 70, halign: 'left' },
                        2: { cellWidth: 20, halign: 'center' },
                        3: { cellWidth: 30, halign: 'right' },
                        4: { cellWidth: 30, halign: 'right' }
                    },
                    margin: { left: 15, right: 15 }
                });
                
                const finalY = doc.lastAutoTable.finalY + 15;
                
                // Totals Section with Background
                doc.setFillColor(248, 249, 250);
                doc.rect(130, finalY + 5, 65, 30, 'F');
                doc.setDrawColor(41, 128, 185);
                doc.rect(130, finalY + 5, 65, 30);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text('Subtotal:', 135, finalY + 15);
                doc.text(`Rs.${(invoice.subtotal || 0).toFixed(2)}`, 165, finalY + 15);
                
                doc.text(`Tax (${(invoice.taxRate || 0)}%):`, 135, finalY + 22);
                doc.text(`Rs.${(invoice.taxAmount || 0).toFixed(2)}`, 165, finalY + 22);
                
                // Grand Total with Highlight
                doc.setFillColor(241, 196, 15);
                doc.rect(130, finalY + 25, 65, 8, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text('GRAND TOTAL:', 135, finalY + 30);
                doc.text(`Rs.${(invoice.grandTotal || 0).toFixed(2)}`, 165, finalY + 30);
                
                // Payment Information Section
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(41, 128, 185);
                doc.text('PAYMENT INFORMATION', 15, finalY + 45);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                if (setting.upiId) {
                    doc.text(`UPI ID: ${setting.upiId}`, 15, finalY + 55);
                }
                doc.text('Bank Details: Please contact for bank transfer details', 15, finalY + 63);
                
                // Footer with Border
                doc.setDrawColor(41, 128, 185);
                doc.line(15, finalY + 75, 195, finalY + 75);
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.setTextColor(41, 128, 185);
                doc.text('Thank You for Your Business!', 15, finalY + 85);
                
                doc.setFont('helvetica', 'italic');
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text('This is a computer generated invoice. No signature required.', 15, finalY + 95);
                doc.text(`Generated by Zentra Inventory Management System on ${new Date().toLocaleString()}`, 15, finalY + 102);
                
                // Page Border
                doc.setDrawColor(41, 128, 185);
                doc.setLineWidth(1);
                doc.rect(10, 10, 190, 277);
                
                doc.save(`Invoice-${invoice.invoiceNumber || 'DRAFT'}.pdf`);
            } catch (error) {
                console.error('PDF Generation Error:', error);
                alert('Error generating PDF. Please try again.');
            }
        }

        // Supplier functions
        async function loadSuppliers() {
            try {
                suppliers = await apiCall('/suppliers');
                const tbody = document.getElementById('suppliersTable');
                tbody.innerHTML = '';
                 if (!suppliers || suppliers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No suppliers found.</td></tr>';
                    return;
                }
                for (const supplier of suppliers) {
                    const analytics = await apiCall(`/suppliers/${supplier.id}/analytics`);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="py-2">${supplier.name}</td>
                        <td class="py-2">${supplier.phone || '-'}</td>
                        <td class="py-2">${supplier.email || '-'}</td>
                        <td class="py-2">${analytics.totalProducts || 0}</td>
                        <td class="py-2">
                            <button onclick="editSupplier(${supplier.id})" class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs mr-1">Edit</button>
                            <button onclick="deleteSupplier(${supplier.id})" class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            } catch (error) {
                console.error('Error loading suppliers:', error);
            }
        }

        function showSupplierModal(supplierId = null) {
            const modal = document.getElementById('supplierModal');
            const form = document.getElementById('supplierForm');
            form.reset();
            
            if (supplierId) {
                const supplier = suppliers.find(s => s.id === supplierId);
                if (supplier) {
                    document.getElementById('supplierId').value = supplier.id;
                    document.getElementById('supplierName').value = supplier.name;
                    document.getElementById('supplierPhone').value = supplier.phone || '';
                    document.getElementById('supplierEmail').value = supplier.email || '';
                    document.getElementById('supplierAddress').value = supplier.address || '';
                }
            } else {
                 document.getElementById('supplierId').value = '';
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideSupplierModal() {
            document.getElementById('supplierModal').classList.add('hidden');
            document.getElementById('supplierModal').classList.remove('flex');
        }

        async function saveSupplier(event) {
            event.preventDefault();
            const supplierData = {
                name: document.getElementById('supplierName').value,
                phone: document.getElementById('supplierPhone').value,
                email: document.getElementById('supplierEmail').value,
                address: document.getElementById('supplierAddress').value
            };
            
            try {
                const id = document.getElementById('supplierId').value;
                if (id) {
                    await apiCall(`/suppliers/${id}`, 'PUT', supplierData);
                } else {
                    await apiCall('/suppliers', 'POST', supplierData);
                }
                hideSupplierModal();
                loadSuppliers();
            } catch (error) {
                alert('Error saving supplier');
            }
        }

        function editSupplier(id) {
            showSupplierModal(id);
        }

        async function deleteSupplier(id) {
            if (confirm('Are you sure you want to delete this supplier?')) {
                try {
                    await apiCall(`/suppliers/${id}`, 'DELETE');
                    loadSuppliers();
                } catch (error) {
                    alert('Error deleting supplier');
                }
            }
        }

        // Expense functions
        async function loadExpenses() {
            try {
                const expenses = await apiCall('/expenses');
                const tbody = document.getElementById('expensesTable');
                tbody.innerHTML = '';
                 if (!expenses || expenses.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No expenses found.</td></tr>';
                    return;
                }
                expenses.forEach(expense => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="py-2">${expense.description}</td>
                        <td class="py-2">${expense.category}</td>
                        <td class="py-2">â‚¹${(expense.amount || 0).toFixed(2)}</td>
                        <td class="py-2">${expense.expenseDate}</td>
                        <td class="py-2">
                            <button onclick="editExpense(${expense.id})" class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs mr-1">Edit</button>
                            <button onclick="deleteExpense(${expense.id})" class="bg-red-600 hover:bg-red-700 px-2 py-1 rounded text-xs">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading expenses:', error);
            }
        }

        async function showExpenseModal(expenseId = null) {
            const modal = document.getElementById('expenseModal');
            const form = document.getElementById('expenseForm');
            form.reset();
            
            if (expenseId) {
                try {
                    const expense = await apiCall(`/expenses/${expenseId}`);
                    document.getElementById('expenseId').value = expense.id;
                    document.getElementById('expenseDescription').value = expense.description;
                    document.getElementById('expenseCategory').value = expense.category;
                    document.getElementById('expenseAmount').value = expense.amount;
                    document.getElementById('expenseDate').value = expense.expenseDate;
                } catch(error) {
                    alert('Could not load expense data.');
                    return;
                }
            } else {
                document.getElementById('expenseId').value = '';
                document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideExpenseModal() {
            document.getElementById('expenseModal').classList.add('hidden');
            document.getElementById('expenseModal').classList.remove('flex');
        }

        async function saveExpense(event) {
            event.preventDefault();
            const expenseData = {
                description: document.getElementById('expenseDescription').value,
                category: document.getElementById('expenseCategory').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                expenseDate: document.getElementById('expenseDate').value
            };
            
            try {
                 const id = document.getElementById('expenseId').value;
                if (id) {
                    await apiCall(`/expenses/${id}`, 'PUT', expenseData);
                } else {
                    await apiCall('/expenses', 'POST', expenseData);
                }
                hideExpenseModal();
                loadExpenses();
                if (!document.getElementById('overview').classList.contains('hidden')) {
                    loadDashboard();
                }
            } catch (error) {
                alert('Error saving expense');
            }
        }

        function editExpense(id) {
            showExpenseModal(id);
        }

        async function deleteExpense(id) {
            if (confirm('Are you sure you want to delete this expense?')) {
                try {
                    await apiCall(`/expenses/${id}`, 'DELETE');
                    loadExpenses();
                     if (!document.getElementById('overview').classList.contains('hidden')) {
                        loadDashboard();
                    }
                } catch (error) {
                    alert('Error deleting expense');
                }
            }
        }
        
        async function deleteInvoice(id) {
            if (confirm('Are you sure you want to delete this invoice?')) {
                try {
                    await apiCall(`/invoices/${id}`, 'DELETE');
                    loadInvoices();
                    alert('Invoice deleted successfully');
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Error deleting invoice. Please try again.');
                }
            }
        }
        
        // Barcode Scanner Functions
        let barcodeScanner = null;
        let scannerContext = null;
        
        function startBarcodeScanner(context = 'inventory') {
            // Check if Quagga is loaded
            if (typeof Quagga === 'undefined') {
                alert('Barcode scanner library not loaded. Please refresh the page.');
                return;
            }
            
            scannerContext = context;
            const modal = document.getElementById('barcodeModal');
            const video = document.getElementById('barcodeVideo');
            const resultDiv = document.getElementById('barcodeResult');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            resultDiv.textContent = '';
            
            // Initialize Quagga barcode scanner
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: video,
                    constraints: {
                        width: { min: 640, ideal: 1280, max: 1920 },
                        height: { min: 480, ideal: 720, max: 1080 },
                        facingMode: "environment",
                        aspectRatio: { ideal: 1.7777777778 }
                    }
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader"
                    ]
                },
                locate: true,
                locator: {
                    halfSample: true,
                    patchSize: "medium"
                }
            }, function(err) {
                if (err) {
                    console.error('Barcode scanner initialization failed:', err);
                    // Try with simpler constraints
                    initSimpleScanner(video, resultDiv);
                    return;
                }
                console.log('Quagga initialized successfully');
                Quagga.start();
                barcodeScanner = true;
            });
        }
        
        function initSimpleScanner(video, resultDiv) {
            // Fallback: Direct camera access
            navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment',
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            }).then(function(stream) {
                video.srcObject = stream;
                video.play();
                resultDiv.textContent = 'Camera ready - manual barcode entry needed';
                barcodeScanner = true;
            }).catch(function(err) {
                console.error('Camera access failed:', err);
                alert('Camera access denied. Please allow camera permissions and try again.');
                stopBarcodeScanner();
            });
            
            // Handle barcode detection
            Quagga.onDetected(onBarcodeDetected);
        }
        
        function stopBarcodeScanner() {
            if (barcodeScanner) {
                Quagga.stop();
                barcodeScanner = null;
            }
            
            const modal = document.getElementById('barcodeModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            
            // Stop video stream
            const video = document.getElementById('barcodeVideo');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        }
        
        async function onBarcodeDetected(result) {
            const barcode = result.codeResult.code;
            const resultDiv = document.getElementById('barcodeResult');
            
            resultDiv.textContent = `Detected: ${barcode}`;
            
            try {
                // Search for product by barcode
                const product = await apiCall(`/products/barcode/${barcode}`);
                
                if (product) {
                    stopBarcodeScanner();
                    handleBarcodeProduct(product, barcode);
                } else {
                    resultDiv.textContent = `Product not found: ${barcode}`;
                    setTimeout(() => {
                        resultDiv.textContent = '';
                    }, 2000);
                }
            } catch (error) {
                console.error('Error searching product:', error);
                resultDiv.textContent = `Product not found: ${barcode}`;
                setTimeout(() => {
                    resultDiv.textContent = '';
                }, 2000);
            }
        }
        
        function handleBarcodeProduct(product, barcode) {
            if (scannerContext === 'inventory') {
                // Show product details or edit modal
                showProductModal(product.id);
            } else if (scannerContext === 'invoice') {
                // Add product to current invoice
                addProductToInvoice(product);
            } else {
                // Default: show product info
                alert(`Product Found: ${product.name}\nPrice: â‚¹${product.sellingPrice}\nStock: ${product.stock}`);
            }
        }
        
        function addProductToInvoice(product) {
            // Find the last invoice item row and populate it
            const items = document.querySelectorAll('.invoice-item');
            let targetItem = null;
            
            // Find empty item or add new one
            for (let item of items) {
                const productId = item.querySelector('.product-id').value;
                if (!productId) {
                    targetItem = item;
                    break;
                }
            }
            
            if (!targetItem) {
                addInvoiceItem();
                const newItems = document.querySelectorAll('.invoice-item');
                targetItem = newItems[newItems.length - 1];
            }
            
            // Populate the item with scanned product
            targetItem.querySelector('.product-search').value = product.name;
            targetItem.querySelector('.product-id').value = product.id;
            targetItem.querySelector('.item-price').value = (product.sellingPrice || 0).toFixed(2);
            targetItem.querySelector('.item-quantity').value = 1;
            
            // Calculate totals
            calculateItemTotal(targetItem.querySelector('.item-quantity'));
            
            alert(`Added: ${product.name} to invoice`);
        }

        // Settings functions
        async function loadSettings() {
            try {
                const settings = await apiCall('/settings');
                if (settings && settings.length > 0) {
                    const setting = settings[0];
                    document.getElementById('businessName').value = setting.businessName || '';
                    document.getElementById('gstin').value = setting.gstin || '';
                    document.getElementById('businessPhone').value = setting.phone || '';
                    document.getElementById('businessEmail').value = setting.email || '';
                    document.getElementById('businessAddress').value = setting.address || '';
                    document.getElementById('defaultTaxRate').value = setting.defaultTaxRate || 18;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        async function saveSettings(event) {
            event.preventDefault();
            const settingsData = {
                businessName: document.getElementById('businessName').value,
                gstin: document.getElementById('gstin').value,
                phone: document.getElementById('businessPhone').value,
                email: document.getElementById('businessEmail').value,
                address: document.getElementById('businessAddress').value,
                defaultTaxRate: parseFloat(document.getElementById('defaultTaxRate').value)
            };
            
            try {
                const settings = await apiCall('/settings');
                if (settings && settings.length > 0) {
                    await apiCall(`/settings/${settings[0].id}`, 'PUT', settingsData);
                } else {
                    await apiCall('/settings', 'POST', settingsData);
                }
                alert('Settings saved successfully!');
            } catch (error) {
                alert('Error saving settings');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('productForm').addEventListener('submit', saveProduct);
            document.getElementById('customerForm').addEventListener('submit', saveCustomer);
            document.getElementById('invoiceForm').addEventListener('submit', saveInvoice);
            document.getElementById('supplierForm').addEventListener('submit', saveSupplier);
            document.getElementById('expenseForm').addEventListener('submit', saveExpense);
            document.getElementById('settingsForm').addEventListener('submit', saveSettings);

            document.addEventListener('click', (event) => {
                if (!event.target.closest('.relative')) {
                    document.querySelectorAll('.search-results').forEach(div => div.classList.add('hidden'));
                }
            });

            showSection('overview');
        });
    </script>
</body>
</html>

